/**
 * Copyright (c) 2020 The Nuinalp and APO Softworks Authors. All rights reserved.
 * Use of this source code is governed by a BSD-style license that can be
 * found in the LICENSE file.
 **/"use strict";var fs=require("fs"),path=require("path"),glob=require("glob");function parseArgs(e){const s={};var[t,o]=e;return e.splice(1).forEach(e=>{var[t,e]=e.split("=");s[t]=e||""}),{stubName:t,stubArgs:{...s,name:o}}}function getStubs(e){var t=path.join(process.cwd(),e);if(!fs.existsSync(t))throw new Error("Stubs directory does not exist");if(!fs.lstatSync(t).isDirectory())throw new Error("Stubs directory is not a directory");var s=fs.readdirSync(t,{withFileTypes:!0}).filter(e=>e.isDirectory());for(let e=0;e<s.length;e++){var o=s[e],n=path.join(t,o.name,"stub.config.json");if(!fs.existsSync(n))throw new Error(`Stub ${o.name} does not have a config file`);try{JSON.parse(fs.readFileSync(n,{encoding:"utf-8"}))}catch(e){throw new Error(`Stub ${o.name} config is not a valid JSON`)}}return s}var Stubber=class{constructor(e,t="",s){var o=path.join(process.cwd(),t);if(!fs.existsSync(o))throw"Stubs directory does not exist";if(!fs.lstatSync(o).isDirectory())throw"Stubs directory is not a directory";var n=fs.readdirSync(o,{withFileTypes:!0}).filter(e=>e.isDirectory());this.callArgs=parseArgs(e);var i=getStubs(t);for(let e=0;e<i.length;e++){var a=n[e],r=path.join(o,a.name,"stub.config.json"),r=JSON.parse(fs.readFileSync(r,{encoding:"utf-8"}));if(r.name===this.callArgs.stubName){this.stubConfig=r,this.stubOriginPath=path.join(o,a.name).replace(/(\\|\/|\\\\|\/\/)/g,"/"),this.stubFileContent=glob.glob.sync(path.join(this.stubOriginPath,"**/*"),{nodir:!0});break}}if(!this.stubConfig)throw`Search for the stub ${this.callArgs.stubName} did not return any results`;s&&(this.stubConfig.targetPath=s)}copy(){const o=this.stubConfig.targetPath;if(!o)throw`Stub ${this.stubConfig.name} does not have a target path, stubber doesn't know where to put it`;this.stubFileContent.forEach(t=>{var e=!(!this.stubConfig.renameToNameFiles||!this.stubConfig.renameToNameFiles.find(e=>e===t.replace(/(\\|\/)/g,"/").replace(this.stubOriginPath,"").split("/").splice(1).join("/"))),e=t.replace(/(\\|\/)/g,"/").replace(this.stubOriginPath,"").replace(e?/\/\w+\./:"",e?`/${this.callArgs.stubArgs.name}.`:"");const s=path.join(process.cwd(),o,e).replace(/(\\|\/)/g,"/");"/stub.config.json"!==e&&(e=s.substring(0,s.lastIndexOf("/")),fs.existsSync(e)||fs.mkdirSync(e,{recursive:!0}),fs.copyFileSync(t,s))})}inject(e){const i={...this.stubConfig.variables,...this.callArgs.stubArgs,...e||{}};this.stubFileContent.forEach(t=>{var e=!(!this.stubConfig.renameToNameFiles||!this.stubConfig.renameToNameFiles.find(e=>e===t.replace(/(\\|\/)/g,"/").replace(this.stubOriginPath,"").split("/").splice(1).join("/"))),s=t.replace(/(\\|\/)/g,"/").replace(this.stubOriginPath,"").replace(e?/\/\w+\./:"",e?`/${this.callArgs.stubArgs.name}.`:""),e=path.join(process.cwd(),this.stubConfig.targetPath,s).replace(/(\\|\/)/g,"/");if("/stub.config.json"!==s){let o=fs.readFileSync(e,{encoding:"utf-8"});const n=o.match(/{{\s*\S+\s*}}/g)||[];n.forEach(e=>{var t=e.replace(/({{|}})/g,"").trim(),s=i[t];s||console.log(`[33mwarning[0m - variable ${t} not found, passing an empty string`),o=o.replace(new RegExp(`${e}`),s||"")}),fs.writeFileSync(e,o,{encoding:"utf-8"})}})}};function listStubs(s){const e=getStubs(s);e.forEach(e=>{e=path.join(process.cwd(),s,e.name,"stub.config.json");const t=JSON.parse(fs.readFileSync(e,{encoding:"utf-8"}));console.log(`
stub: ${t.name}`),t.description&&console.log("description:",70<t.description.length?`${t.description.substring(0,70)}...`:t.description)})}var[action,...args]=process.argv.splice(2);if(action)if("commands"===action)console.log("\n[47m[30m Stubber commands [0m\n\n"),console.log("[47m[30m help [0m - A short description of how to instantiate and use the stubber. Accepts an second argument of the stub name, and return it's description\n"),console.log("[47m[30m commands [0m - displays this text of list of commands\n"),console.log("[47m[30m spawn [0m - receives a required argument of the name of the stub to use\n"),console.log("[47m[30m list [0m - list all available stubs to spawn\n");else if("help"===action)console.log("\n[47m[30m Stubber help [0m\n\n"),console.log("Creating your stubs\n"),console.log("By any way this is a complete guide, just a quickstart, you can read more in https://github.com/AcaiFramework/stubber"),console.log("To create your stubs, the first thing you will need is a directory to them. Stubber defaults to `/stubs`, but you can overwrite it using `--stubDir=/path/to/dir`, each folder inside of it will be considered a different stub, and all of them require a file called `stub.config.json`, where it's name and identifier can be found."),console.log("You need two keys: name and targetPath, that's where the stub will be place when called. Behaviour that you can overwrite using `--target=/new/path`, every other file inside of the stub, will be copied to the target path, meaning you can write variables inside of them."),console.log("To declare those variables, you will enclose them within double brackets, like this: `{{ variableName }}`, there are many types of variables and you can read about them in our documentation. The variable name defaults to the name you give your stub."),console.log("\nUsing them\n"),console.log("You can call this package within your terminal, we recommend saving it in your package.json, so you can alias it to a smaller form. Let's say for example you have a stub called Component and wants to use it, just call: `yarn stub spawn Component MyComponent` and there you have it."),console.log("");else if("list"===action)console.log("\n[47m[30m List of available stubs [0m"),console.log("You can read more with command help {stubName}"),listStubs((args.find(e=>e.match("--stubDir="))||"--stubDir=/stubs").replace("--stubDir=","")),console.log("");else{if("spawn"!==action)throw"Command not found, see list of commands to see all available options";{if(args.length<2)throw"Not enough arguments to spawn the required stub";console.log(`
Spawning stub ${args[0]}`);const Z=new Stubber(args,(args.find(e=>e.match("--stubDir="))||"--stubDir=/stubs").replace("--stubDir=",""));Z.copy(),Z.inject(),console.log("")}}else console.log(""),console.log("[47m[30m Welcome to the stubber [0m\n"),console.log("Stubber is part of the [4m[35mA√ßa√≠ framework[37m and is used to easily create commonly used files, such as controllers, middlewares or components. You can checkout the help or commands action to see how to use it. You can chekout a more detailed documentation at: https://github.com/AcaiFramework/stubber"),console.log("");
//# sourceMappingURL=index.js.map
